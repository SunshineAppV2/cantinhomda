generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Club {
  id                    String              @id @default(uuid())
  name                  String
  slug                  String?             @unique
  logoUrl               String?
  settings              Json?
  region                String?
  mission               String?
  union                 String?
  planTier              PlanTier            @default(TRIAL)
  memberLimit           Int                 @default(30)
  subscriptionStatus    SubscriptionStatus  @default(TRIAL)
  nextBillingDate       DateTime?
  gracePeriodDays       Int                 @default(5)
  status                ClubStatus          @default(ACTIVE)
  subscriptionId        String?
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  referralCode          String?             @unique
  referralRewardClaimed Boolean             @default(false)
  referrerClubId        String?
  association           String?
  district              String?
  phoneNumber           String?
  activities            Activity[]
  auditLogs             AuditLog[]
  referrerClub          Club?               @relation("ClubReferrals", fields: [referrerClubId], references: [id])
  referrals             Club[]              @relation("ClubReferrals")
  events                Event[]
  masterTransactions    MasterTransaction[]
  meetings              Meeting[]
  minutes               Minute[]
  products              Product[]
  referralCredits       ReferralCredit[]
  requirements          Requirement[]
  transactions          Transaction[]
  units                 Unit[]
  users                 User[]

  @@map("clubs")
}

model ReferralCredit {
  id        String   @id @default(uuid())
  clubId    String
  status    String   @default("AVAILABLE")
  expiresAt DateTime
  createdAt DateTime @default(now())
  club      Club     @relation(fields: [clubId], references: [id])

  @@map("referral_credits")
}

model Unit {
  id      String @id @default(uuid())
  name    String
  clubId  String
  club    Club   @relation(fields: [clubId], references: [id], onDelete: Cascade)
  members User[]

  @@map("units")
}

model User {
  id                     String              @id @default(uuid())
  email                  String              @unique
  password               String
  name                   String
  photoUrl               String?
  role                   Role                @default(PATHFINDER)
  isActive               Boolean             @default(true)
  status                 UserStatus          @default(ACTIVE)
  points                 Int                 @default(0)
  lastClassMilestone     Int                 @default(0)
  dbvClass               DBVClass?
  clubId                 String?
  unitId                 String?
  parentId               String?
  createdAt              DateTime            @default(now())
  updatedAt              DateTime            @updatedAt
  sex                    String?
  birthDate              DateTime?
  maritalStatus          String?
  phone                  String?
  mobile                 String?
  isBaptized             Boolean             @default(false)
  rg                     String?
  issuingOrg             String?
  cpf                    String?
  shirtSize              String?
  address                String?
  addressNumber          String?
  neighborhood           String?
  cep                    String?
  city                   String?
  state                  String?
  complement             String?
  educationLevel         String?
  educationStatus        String?
  knowledgeArea          String?
  courseName             String?
  institution            String?
  schoolShift            String?
  isHealthProfessional   Boolean             @default(false)
  healthProfessionalType String?
  fatherName             String?
  fatherEmail            String?
  fatherPhone            String?
  motherName             String?
  motherEmail            String?
  motherPhone            String?
  emergencyName          String?
  emergencyPhone         String?
  emergencyRelation      String?
  susNumber              String?
  healthPlan             String?
  bloodType              String?
  rhFactor               String?
  diseasesHistory        String[]            @default([])
  hasHeartProblem        Boolean?            @default(false)
  heartProblemDesc       String?
  hasDiabetes            Boolean?            @default(false)
  hasRenalProblem        Boolean?            @default(false)
  hasPsychProblem        Boolean?            @default(false)
  regularMedications     String?
  specificAllergies      String?
  recentTrauma           String?
  recentFracture         String?
  recentSurgery          String?
  disabilities           String[]            @default([])
  healthNotes            String?
  mustChangePassword     Boolean             @default(false)
  association            String?
  district               String?
  region                 String?
  mission                String?
  union                  String?
  logs                   ActivityLog[]
  attendances            Attendance[]
  auditLogs              AuditLog[]
  registrations          EventRegistration[]
  authoredMinutes        Minute[]            @relation("AuthoredMinutes")
  notifications          Notification[]
  pointsHistory          PointHistory[]
  purchases              Purchase[]
  memberTransactions     Transaction[]       @relation("TransactionMember")
  transactions           Transaction[]
  requirements           UserRequirement[]
  specialties            UserSpecialty[]
  club                   Club?               @relation(fields: [clubId], references: [id])
  parent                 User?               @relation("ParentChildren", fields: [parentId], references: [id])
  children               User[]              @relation("ParentChildren")
  unit                   Unit?               @relation(fields: [unitId], references: [id])

  @@map("users")
}

model Activity {
  id          String        @id @default(uuid())
  title       String
  description String?
  points      Int
  type        String        @default("INDIVIDUAL")
  clubId      String
  createdAt   DateTime      @default(now())
  club        Club          @relation(fields: [clubId], references: [id], onDelete: Cascade)
  logs        ActivityLog[]
  events      Event[]
  meetings    Meeting[]

  @@map("activities")
}

model ActivityLog {
  id         String   @id @default(uuid())
  userId     String
  activityId String
  awardedAt  DateTime @default(now())
  activity   Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("activity_logs")
}

model PointHistory {
  id        String   @id @default(uuid())
  userId    String
  amount    Int
  reason    String
  source    String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("point_history")
}

model Meeting {
  id          String       @id @default(uuid())
  title       String
  date        DateTime
  type        String       @default("REGULAR")
  points      Int          @default(10)
  details     String?
  clubId      String
  activityId  String?
  createdAt   DateTime     @default(now())
  attendances Attendance[]
  activity    Activity?    @relation(fields: [activityId], references: [id])
  club        Club         @relation(fields: [clubId], references: [id], onDelete: Cascade)

  @@map("meetings")
}

model Attendance {
  id        String           @id @default(uuid())
  status    AttendanceStatus @default(PRESENT)
  userId    String
  meetingId String
  createdAt DateTime         @default(now())
  meeting   Meeting          @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, meetingId])
  @@map("attendances")
}

model Specialty {
  id           String          @id @default(uuid())
  name         String
  area         String
  imageUrl     String?
  requirements Requirement[]
  users        UserSpecialty[]

  @@map("specialties")
}

model UserSpecialty {
  id          String              @id @default(uuid())
  status      UserSpecialtyStatus @default(IN_PROGRESS)
  userId      String
  specialtyId String
  awardedAt   DateTime            @default(now())
  specialty   Specialty           @relation(fields: [specialtyId], references: [id], onDelete: Cascade)
  user        User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, specialtyId])
  @@map("user_specialties")
}

model Requirement {
  id           String            @id @default(uuid())
  code         String?
  description  String
  area         String?
  type         RequirementType   @default(TEXT)
  dbvClass     DBVClass?
  specialtyId  String?
  clubId       String?
  createdAt    DateTime          @default(now())
  district     String?
  region       String?
  questions    Question[]
  club         Club?             @relation(fields: [clubId], references: [id], onDelete: Cascade)
  specialty    Specialty?        @relation(fields: [specialtyId], references: [id], onDelete: Cascade)
  userProgress UserRequirement[]

  @@map("requirements")
}

model Question {
  id            String      @id @default(uuid())
  questionText  String
  options       String[]
  correctIndex  Int
  requirementId String
  requirement   Requirement @relation(fields: [requirementId], references: [id], onDelete: Cascade)

  @@map("questions")
}

model UserRequirement {
  id            String            @id @default(uuid())
  status        RequirementStatus @default(PENDING)
  answerText    String?
  answerFileUrl String?
  completedAt   DateTime?
  userId        String
  requirementId String
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  requirement   Requirement       @relation(fields: [requirementId], references: [id], onDelete: Cascade)
  user          User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, requirementId])
  @@map("user_requirements")
}

model Transaction {
  id            String            @id @default(uuid())
  type          TransactionType
  amount        Float
  description   String
  date          DateTime          @default(now())
  category      String
  status        TransactionStatus @default(COMPLETED)
  dueDate       DateTime?
  proofUrl      String?
  recurrence    Boolean           @default(false)
  points        Int               @default(0)
  paymentMethod String            @default("DINHEIRO")
  clubId        String
  payerId       String?
  memberId      String?
  createdAt     DateTime          @default(now())
  club          Club              @relation(fields: [clubId], references: [id], onDelete: Cascade)
  member        User?             @relation("TransactionMember", fields: [memberId], references: [id])
  payer         User?             @relation(fields: [payerId], references: [id])

  @@map("transactions")
}

model Event {
  id            String              @id @default(uuid())
  title         String
  startDate     DateTime
  endDate       DateTime
  cost          Float               @default(0)
  description   String?
  location      String?
  activityId    String?
  clubId        String
  createdAt     DateTime            @default(now())
  registrations EventRegistration[]
  activity      Activity?           @relation(fields: [activityId], references: [id])
  club          Club                @relation(fields: [clubId], references: [id], onDelete: Cascade)

  @@map("events")
}

model EventRegistration {
  id           String   @id @default(uuid())
  status       String   @default("PENDING")
  userId       String
  eventId      String
  attended     Boolean  @default(false)
  registeredAt DateTime @default(now())
  event        Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, eventId])
  @@map("event_registrations")
}

model Product {
  id          String     @id @default(uuid())
  name        String
  description String?
  price       Int
  stock       Int        @default(-1)
  imageUrl    String?
  category    String     @default("REAL")
  clubId      String
  createdAt   DateTime   @default(now())
  club        Club       @relation(fields: [clubId], references: [id], onDelete: Cascade)
  purchases   Purchase[]

  @@map("products")
}

model Purchase {
  id        String   @id @default(uuid())
  cost      Int
  status    String   @default("PENDING")
  userId    String
  productId String
  createdAt DateTime @default(now())
  product   Product  @relation(fields: [productId], references: [id])
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("purchases")
}

model Notification {
  id        String   @id @default(uuid())
  title     String
  message   String
  type      String   @default("INFO")
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model FAQ {
  id        String   @id @default(uuid())
  question  String
  answer    String
  category  String   @default("GERAL")
  isVisible Boolean  @default(false)
  createdAt DateTime @default(now())

  @@map("faqs")
}

model MasterTransaction {
  id           String          @id @default(uuid())
  type         TransactionType
  amount       Float
  description  String
  category     String
  date         DateTime        @default(now())
  sourceClubId String?
  createdAt    DateTime        @default(now())
  sourceClub   Club?           @relation(fields: [sourceClubId], references: [id])

  @@map("master_transactions")
}

model SystemSetting {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String
  updatedAt DateTime @updatedAt

  @@map("system_settings")
}

model Minute {
  id        String     @id @default(uuid())
  title     String
  content   String
  date      DateTime
  clubId    String
  authorId  String
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  attendees Json?
  number    Int?
  year      Int        @default(2025)
  type      MinuteType @default(ORDINARIA)
  author    User       @relation("AuthoredMinutes", fields: [authorId], references: [id])
  club      Club       @relation(fields: [clubId], references: [id])

  @@map("minutes")
}

model AuditLog {
  id         String   @id @default(uuid())
  action     String
  resource   String
  resourceId String?
  details    Json?
  ipAddress  String?
  authorId   String?
  clubId     String?
  createdAt  DateTime @default(now())
  author     User?    @relation(fields: [authorId], references: [id])
  club       Club?    @relation(fields: [clubId], references: [id])

  @@map("audit_logs")
}

enum Role {
  OWNER
  ADMIN
  INSTRUCTOR
  PARENT
  PATHFINDER
  COUNSELOR
  COORDINATOR_REGIONAL
  MASTER
  DIRECTOR
  COORDINATOR_AREA
  COORDINATOR_DISTRICT
}

enum PlanTier {
  FREE
  TRIAL
  PLAN_P
  PLAN_M
  PLAN_G
}

enum SubscriptionStatus {
  ACTIVE
  OVERDUE
  CANCELED
  TRIAL
}

enum ClubStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum DBVClass {
  AMIGO
  COMPANHEIRO
  PESQUISADOR
  PIONEIRO
  EXCURSIONISTA
  GUIA
}

enum UserStatus {
  PENDING
  ACTIVE
  BLOCKED
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  JUSTIFIED
}

enum RequirementType {
  TEXT
  FILE
  BOTH
  QUESTIONNAIRE
}

enum RequirementStatus {
  PENDING
  APPROVED
  REJECTED
}

enum UserSpecialtyStatus {
  IN_PROGRESS
  WAITING_APPROVAL
  COMPLETED
}

enum TransactionType {
  INCOME
  EXPENSE
}

enum TransactionStatus {
  PENDING
  WAITING_APPROVAL
  COMPLETED
  CANCELED
}

enum MinuteType {
  ORDINARIA
  EXTRAORDINARIA
  ATO_ADMINISTRATIVO
  OUTRO
}
