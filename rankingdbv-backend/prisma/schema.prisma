generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x", "rhel-openssl-1.0.x", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Club {
  id                 String              @id @default(uuid())
  name               String
  slug               String?             @unique
  phoneNumber        String?
  logoUrl            String?
  planTier           PlanTier            @default(TRIAL)
  status             ClubStatus          @default(ACTIVE)
  subscriptionId     String?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  mission            String?
  union              String?
  settings           Json?
  region             String?
  district           String?
  association        String?
  gracePeriodDays    Int                 @default(5)
  memberLimit        Int                 @default(30)
  nextBillingDate    DateTime?
  subscriptionStatus SubscriptionStatus  @default(TRIAL)
  activities         Activity[]
  events             Event[]
  masterTransactions MasterTransaction[]
  meetings           Meeting[]
  minutes            Minute[]
  products           Product[]
  requirements       Requirement[]
  transactions       Transaction[]
  units              Unit[]
  users              User[]
  referralCode          String?             @unique
  referralCredits       ReferralCredit[]

  // Delayed Reward Logic
  referrerClubId        String?
  referrerClub          Club?               @relation("ClubReferrals", fields: [referrerClubId], references: [id])
  referrals             Club[]              @relation("ClubReferrals")
  referralRewardClaimed Boolean             @default(false)
  auditLogs             AuditLog[]

  @@map("clubs")
}

model ReferralCredit {
  id        String   @id @default(uuid())
  clubId    String
  club      Club     @relation(fields: [clubId], references: [id])
  status    String   @default("AVAILABLE") // AVAILABLE, USED, EXPIRED
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@map("referral_credits")
}






model Unit {
  id      String @id @default(uuid())
  name    String
  clubId  String
  club    Club   @relation(fields: [clubId], references: [id], onDelete: Cascade)
  members User[]

  @@map("units")
}

model User {
  id                     String              @id @default(uuid())
  email                  String              @unique
  password               String
  name                   String
  photoUrl               String?
  role                   Role                @default(PATHFINDER)
  clubId                 String?
  createdAt              DateTime            @default(now())
  updatedAt              DateTime            @updatedAt
  points                 Int                 @default(0)
  dbvClass               DBVClass?
  unitId                 String?
  parentId               String?
  lastClassMilestone     Int                 @default(0)
  address                String?
  addressNumber          String?
  birthDate              DateTime?
  bloodType              String?
  cep                    String?
  city                   String?
  complement             String?
  courseName             String?
  cpf                    String?
  disabilities           String[]            @default([])
  diseasesHistory        String[]            @default([])
  educationLevel         String?
  educationStatus        String?
  emergencyName          String?
  emergencyPhone         String?
  emergencyRelation      String?
  fatherEmail            String?
  fatherName             String?
  fatherPhone            String?
  hasDiabetes            Boolean?            @default(false)
  hasHeartProblem        Boolean?            @default(false)
  hasPsychProblem        Boolean?            @default(false)
  hasRenalProblem        Boolean?            @default(false)
  healthNotes            String?
  healthPlan             String?
  healthProfessionalType String?
  heartProblemDesc       String?
  institution            String?
  isBaptized             Boolean             @default(false)
  isHealthProfessional   Boolean             @default(false)
  issuingOrg             String?
  knowledgeArea          String?
  maritalStatus          String?
  mobile                 String?
  motherEmail            String?
  motherName             String?
  motherPhone            String?
  neighborhood           String?
  phone                  String?
  recentFracture         String?
  recentSurgery          String?
  recentTrauma           String?
  regularMedications     String?
  rg                     String?
  rhFactor               String?
  sex                    String?
  shirtSize              String?
  specificAllergies      String?
  state                  String?
  susNumber              String?
  region                 String?
  district               String?
  association            String?
  union                  String?
  mission                String?
  isActive               Boolean             @default(true)
  mustChangePassword     Boolean             @default(false)
  schoolShift            String?
  status                 UserStatus          @default(ACTIVE)
  logs                   ActivityLog[]
  attendances            Attendance[]
  registrations          EventRegistration[]
  authoredMinutes        Minute[]            @relation("AuthoredMinutes")
  notifications          Notification[]
  pointsHistory          PointHistory[]
  purchases              Purchase[]
  memberTransactions     Transaction[]       @relation("TransactionMember")
  transactions           Transaction[]
  requirements           UserRequirement[]
  specialties            UserSpecialty[]
  club                   Club?               @relation(fields: [clubId], references: [id])
  parent                 User?               @relation("ParentChildren", fields: [parentId], references: [id])
  children               User[]              @relation("ParentChildren")
  unit                   Unit?               @relation(fields: [unitId], references: [id])
  auditLogs              AuditLog[]

  @@map("users")
}

model Activity {
  id          String        @id @default(uuid())
  title       String
  description String?
  points      Int
  clubId      String
  createdAt   DateTime      @default(now())
  type        String        @default("INDIVIDUAL")
  club        Club          @relation(fields: [clubId], references: [id], onDelete: Cascade)
  logs        ActivityLog[]
  events      Event[]
  meetings    Meeting[]

  @@map("activities")
}

model ActivityLog {
  id         String   @id @default(uuid())
  userId     String
  activityId String
  awardedAt  DateTime @default(now())
  activity   Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("activity_logs")
}

model PointHistory {
  id        String   @id @default(uuid())
  userId    String
  amount    Int
  reason    String
  source    String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("point_history")
}

model Meeting {
  id          String       @id @default(uuid())
  title       String
  date        DateTime
  type        String       @default("REGULAR")
  points      Int          @default(10)
  clubId      String
  createdAt   DateTime     @default(now())
  activityId  String?
  details     String?
  attendances Attendance[]
  activity    Activity?    @relation(fields: [activityId], references: [id])
  club        Club         @relation(fields: [clubId], references: [id], onDelete: Cascade)

  @@map("meetings")
}

model Attendance {
  id        String           @id @default(uuid())
  status    AttendanceStatus @default(PRESENT)
  userId    String
  meetingId String
  createdAt DateTime         @default(now())
  meeting   Meeting          @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, meetingId])
  @@map("attendances")
}

model Specialty {
  id           String          @id @default(uuid())
  name         String
  area         String
  imageUrl     String?
  requirements Requirement[]
  users        UserSpecialty[]

  @@map("specialties")
}

model UserSpecialty {
  id          String              @id @default(uuid())
  userId      String
  specialtyId String
  awardedAt   DateTime            @default(now())
  status      UserSpecialtyStatus @default(IN_PROGRESS)
  specialty   Specialty           @relation(fields: [specialtyId], references: [id], onDelete: Cascade)
  user        User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, specialtyId])
  @@map("user_specialties")
}

model Requirement {
  id           String            @id @default(uuid())
  code         String?
  description  String
  dbvClass     DBVClass?
  specialtyId  String?
  createdAt    DateTime          @default(now())
  area         String?
  type         RequirementType   @default(TEXT)
  clubId       String?
  region       String?
  district     String?
  questions    Question[]
  club         Club?             @relation(fields: [clubId], references: [id], onDelete: Cascade)
  specialty    Specialty?        @relation(fields: [specialtyId], references: [id], onDelete: Cascade)
  userProgress UserRequirement[]

  @@map("requirements")
}

model Question {
  id            String      @id @default(uuid())
  questionText  String
  options       String[]
  correctIndex  Int
  requirementId String
  requirement   Requirement @relation(fields: [requirementId], references: [id], onDelete: Cascade)

  @@map("questions")
}

model UserRequirement {
  id            String            @id @default(uuid())
  completedAt   DateTime?
  userId        String
  requirementId String
  answerFileUrl String?
  answerText    String?
  status        RequirementStatus @default(PENDING)
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  requirement   Requirement       @relation(fields: [requirementId], references: [id], onDelete: Cascade)
  user          User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, requirementId])
  @@map("user_requirements")
}

model Transaction {
  id            String            @id @default(uuid())
  type          TransactionType
  amount        Float
  description   String
  date          DateTime          @default(now())
  category      String
  clubId        String
  payerId       String?
  createdAt     DateTime          @default(now())
  dueDate       DateTime?
  paymentMethod String            @default("DINHEIRO")
  points        Int               @default(0)
  proofUrl      String?
  recurrence    Boolean           @default(false)
  status        TransactionStatus @default(COMPLETED)
  memberId      String?
  club          Club              @relation(fields: [clubId], references: [id], onDelete: Cascade)
  member        User?             @relation("TransactionMember", fields: [memberId], references: [id])
  payer         User?             @relation(fields: [payerId], references: [id])

  @@map("transactions")
}

model Event {
  id            String              @id @default(uuid())
  title         String
  cost          Float               @default(0)
  description   String?
  location      String?
  clubId        String
  createdAt     DateTime            @default(now())
  endDate       DateTime
  startDate     DateTime
  activityId    String?
  registrations EventRegistration[]
  activity      Activity?           @relation(fields: [activityId], references: [id])
  club          Club                @relation(fields: [clubId], references: [id], onDelete: Cascade)

  @@map("events")
}

model EventRegistration {
  id           String   @id @default(uuid())
  status       String   @default("PENDING")
  userId       String
  eventId      String
  registeredAt DateTime @default(now())
  attended     Boolean  @default(false)
  event        Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, eventId])
  @@map("event_registrations")
}

model Product {
  id          String     @id @default(uuid())
  name        String
  description String?
  price       Int
  stock       Int        @default(-1)
  imageUrl    String?
  category    String     @default("REAL")
  clubId      String
  createdAt   DateTime   @default(now())
  club        Club       @relation(fields: [clubId], references: [id], onDelete: Cascade)
  purchases   Purchase[]

  @@map("products")
}

model Purchase {
  id        String   @id @default(uuid())
  cost      Int
  status    String   @default("PENDING")
  userId    String
  productId String
  createdAt DateTime @default(now())
  product   Product  @relation(fields: [productId], references: [id])
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("purchases")
}

model Notification {
  id        String   @id @default(uuid())
  title     String
  message   String
  type      String   @default("INFO")
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model FAQ {
  id        String   @id @default(uuid())
  question  String
  answer    String
  category  String   @default("GERAL")
  isVisible Boolean  @default(false)
  createdAt DateTime @default(now())

  @@map("faqs")
}

model MasterTransaction {
  id           String          @id @default(uuid())
  type         TransactionType
  amount       Float
  description  String
  category     String
  date         DateTime        @default(now())
  sourceClubId String?
  createdAt    DateTime        @default(now())
  sourceClub   Club?           @relation(fields: [sourceClubId], references: [id])

  @@map("master_transactions")
}

enum Role {
  OWNER
  ADMIN
  INSTRUCTOR
  PARENT
  PATHFINDER
  COUNSELOR
  COORDINATOR_REGIONAL
  MASTER
  DIRECTOR
  COORDINATOR_AREA
  COORDINATOR_DISTRICT
}

enum PlanTier {
  FREE
  TRIAL
  PLAN_P
  PLAN_M
  PLAN_G
}

enum SubscriptionStatus {
  ACTIVE
  OVERDUE
  CANCELED
  TRIAL
}

enum ClubStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum DBVClass {
  AMIGO
  COMPANHEIRO
  PESQUISADOR
  PIONEIRO
  EXCURSIONISTA
  GUIA
}

enum UserStatus {
  PENDING
  ACTIVE
  BLOCKED
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  JUSTIFIED
}

enum RequirementType {
  TEXT
  FILE
  BOTH
  QUESTIONNAIRE
}

enum RequirementStatus {
  PENDING
  APPROVED
  REJECTED
}

enum UserSpecialtyStatus {
  IN_PROGRESS
  WAITING_APPROVAL
  COMPLETED
}

enum TransactionType {
  INCOME
  EXPENSE
}

enum TransactionStatus {
  PENDING
  WAITING_APPROVAL
  COMPLETED
  CANCELED
}

model SystemSetting {
  id    String @id @default(uuid())
  key   String @unique
  value String // JSON string
  updatedAt DateTime @updatedAt

  @@map("system_settings")
}

model Minute {
  id        String     @id @default(uuid())
  number    Int?       // Sequential number
  year      Int        @default(2025)
  title     String
  date      DateTime
  type      MinuteType @default(ORDINARIA)
  content   String     @db.Text
  attendees Json?      // List of attendees

  clubId    String
  club      Club       @relation(fields: [clubId], references: [id])

  authorId  String
  author    User       @relation("AuthoredMinutes", fields: [authorId], references: [id])

  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@map("minutes")
}

enum MinuteType {
  ORDINARIA
  EXTRAORDINARIA
  ATO_ADMINISTRATIVO
  OUTRO
}

model AuditLog {
  id        String   @id @default(uuid())
  action    String   // CREATE, UPDATE, DELETE, LOGIN, CHANGE_ROLE, ETC
  resource  String   // User, Club, Transaction, SystemSetting
  resourceId String?
  details   Json?    // Stores 'before' and 'after' or specific details
  ipAddress String?
  
  authorId  String?
  author    User?    @relation(fields: [authorId], references: [id])

  clubId    String?
  club      Club?    @relation(fields: [clubId], references: [id])

  createdAt DateTime @default(now())

  @@map("audit_logs")
}
